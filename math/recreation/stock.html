<title>股票模拟器</title>
<link rel="stylesheet" href="../../css/vanilla-ui.css">
<style>
* {
  box-sizing: border-box;
}
body {
  margin: 0;
  min-height: 100%;
  background-color: #191927;
  color: #eee;
}
main {
  margin: 0 auto;
  max-width: 800px;
  height: 100%;
  padding: 40px;
  display: flex;
  flex-direction: column;
}
.notification {
  position: fixed;
  right: 10px;
  top: 10px;
  font-size: 14px;
}
.chart-container {
  position: relative;
  display: flex;
  flex: 1;
}
.chart {
  --stroke-length: 0;
}
.chart-path {
	stroke-dasharray: var(--stroke-length);
	stroke-dashoffset: var(--stroke-length);
  transition: stroke-dashoffset .5s;
}
.chart-circle {
  r: 1;
  stroke-width: 1;
  fill: #5879bf;
  cursor: pointer;
  transition: all .3s;
}
.chart-circle.has-operate,
.chart-circle:hover,
.chart-circle:active {
  r: 3;
  stroke-width: 2;
  fill: #fff;
}
.chart-tooltip {
  display: none;
  position: absolute;
  color: #fff;
  background-color: #363751;
  border-radius: 8px;
  white-space: pre-wrap;
  pointer-events: none;
  padding: 4px 8px;
  font-size: 12px;
  text-align: center;
  transform: translate(-50%, calc(-100% - 10px));
}
.state {
  padding: 16px;
  border-radius: 16px;
  background-color: #363751;
}
.btn-group {
  padding: 10px 0;
}
button {
  cursor: pointer;
  border: none;
  border-radius: 4px;
  background-color: #5879bf;
  color: #fff;
  font-size: 16px;
  padding: 4px 8px;
}
</style>

<body>
<div class="notification">仅供娱乐，切勿当真<br>股市有风险，入市需谨慎</div>
<main>
<div class="chart-container">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 100" class="chart"></svg>
  <div class="chart-tooltip"></div>
</div>
<div class="state">
  <div>天数: <span class="span-day"></span></div>
  <div>现金: <span class="span-cash"></span></div>
  <div>持仓: <span class="span-stock"></span></div>
  <div>股价: <span class="span-price"></span></div>
  <div>涨跌: <span class="span-rate"></span></div>
  <div>收益: <span class="span-gain"></span></div>
</div>

<div class="btn-group">
  <button class="btn-next">下一天</button>
  <button class="btn-buy">买入</button>
  <button class="btn-sell">卖出</button>
  <button class="btn-finish">结算</button>
</div>
</main>

<script type="module">
// import { Console } from '../../js/vanilla-ui.js'
// Console()

const $ = el => document.querySelector(el)
const svg = ({ tag = 'svg', attr = {}, className = '' } = {}) => {
  const el = document.createElementNS('http://www.w3.org/2000/svg', tag)
  if (className) el.classList.add(className)
  Object.entries(attr).map(([k, v]) => el.setAttribute(k, v))
  return el
}

const Utils = {
  round (x, digits) {
    const d = Math.pow(10, digits)
    return Math.round(x * d) / d
  },
  // 返回 [-1, 1] 之间的随机数, 密度函数呈金字塔形
  rand () {
    const x = Math.random() * 2 - 1 // [-1, 1]
    const y = Math.random() // [0, 1]
    return y < Math.abs(x) ? Math.sign(x) * y : x
  },
}

const Market = {
  config: {
    initCash: 1e6, // 初始资金
    initPrice: 1e4, // 初始价格
    fee: 1e-3, // 买卖手续费
    threshold: 0.1, // 涨停/跌停线
  },
  state: undefined,
  init () {
    this.state = {
      day: 0, // 日期
      price: this.config.initPrice, // 当前股价
      stock: 0, // 当前持仓 (本金 + 收益)
      cash: this.config.initCash, // 现金
      sum: 0, // 买入本金
      history: [this.config.initPrice], // 历史涨跌幅
      operations: [], // 历史操作
    }
  },
  // value 单位: 分
  buy (value) {
    value = Math.round(Math.min(this.state.cash, value))
    this.state.operations[this.state.day] ||= 0
    this.state.operations[this.state.day] += value
    this.state.cash -= value
    this.state.sum += value
    return this.state.stock += Math.round(value * (1 - this.config.fee))
  },
  // value 单位: 分
  sell (value) {
    value = Math.round(Math.min(this.state.stock, value))
    this.state.operations[this.state.day] ||= 0
    this.state.operations[this.state.day] -= value
    this.state.cash += Math.round(value * (1 - this.config.fee))
    this.state.sum -= value
    return this.state.stock -= value
  },
  next () {
    ++this.state.day
    const rate = Utils.rand() * this.config.threshold
    this.state.price = Math.round(this.state.price * (1 + rate))
    this.state.stock = Math.round(this.state.stock * (1 + rate))
    this.state.history.push(this.state.price)
    return this.state.stock
  },
  show () {
    const rate = Utils.round((this.state.history.at(-1) / this.state.history.at(-2) - 1) * 100, 2) || 0
    const gain = Utils.round((this.state.stock / Math.max(0, this.state.sum) - 1) * 100, 2) || 0 // 持有收益率可能为 Infinity, 这表明最初的本金都已收回
    $('.span-day').innerText = this.state.day
    $('.span-cash').innerText = this.state.cash / 100
    $('.span-stock').innerText = this.state.stock / 100
    $('.span-price').innerText = this.state.price / 100
    $('.span-rate').innerText = rate + '%'
    $('.span-gain').innerText = gain + '%'
  },
  finish () {
    const { cash, stock, day } = this.state
    const gain = Utils.round(((cash + stock) / this.config.initCash - 1) * 100, 2) || 0
    window.alert(
      `天数: ${day}
总资产: ${(cash + stock) / 100}
收益率: ${gain}%`
    )
  },
  plot ({ width = 200, height = 100, padding = 10, color = '#5879bf', anim = true } = {}) {
    const chart = $('.chart')
    const g = svg({
      tag: 'g',
      attr: {
        transform: `translate(0, ${height}) scale(1, -1)`,
      },
    })
    const { history } = this.state
    const len = history.length
    const max = Math.max(...history)
    const min = Math.min(...history)
    const polyline = history.map((price, i) => {
      const x = padding + (width - 2 * padding) * (i / (len - 1) || 0)
      const y = padding + (height - 2 * padding) * ((price - min) / (max - min) || 0)
      return [x, y]
    })

    const path = svg({
      tag: 'path',
      className: 'chart-path',
      attr: {
        d: `M ${polyline.join(' ')}`,
        fill: 'none',
        stroke: color,
        'stroke-width': 3,
        'stroke-linecap': 'round',
        'stroke-linejoin': 'round',
      }
    })

    // 动画
    const totalLength = Math.ceil(path.getTotalLength())
    chart.style.setProperty('--stroke-length', totalLength)
    if (anim) {
      setTimeout(() => {
        path.style.strokeDashoffset = 0
      }, 0)
    } else {
      path.style.strokeDashoffset = 0
    }

    g.appendChild(path)

    polyline.forEach(([x, y], i) => {
      const value = this.state.operations[i] || 0
      const price = this.state.history[i] / 100
      const operate = value > 0 ? `买入${value / 100}` : value < 0 ? `卖出${-value / 100}` : ''
      const touch = svg({
        tag: 'circle',
        className: 'chart-touch',
        attr: {
          cx: x,
          cy: y,
          r: 10,
          fill: 'transparent',
          stroke: 'none',
          'data-price': price,
          'data-operate': operate,
        },
      })
      g.appendChild(touch)

      const circle = svg({
        tag: 'circle',
        className: 'chart-circle',
        attr: {
          cx: x,
          cy: y,
          stroke: value > 0 ? '#ff4d4f' : value < 0 ? '#52c41a' : color,
          'data-price': price,
          'data-operate': operate,
        },
      })
      if (value) circle.classList.add('has-operate')
      g.appendChild(circle)
    })

    chart.innerHTML = ''
    chart.appendChild(g)
  },
}

Market.init()
Market.show()
Market.plot()
$('.btn-next').onclick = () => {
  Market.next()
  Market.show()
  Market.plot()
  if (Market.state.day % 30 === 0) setTimeout(() => Market.finish(), 100)
}
$('.btn-buy').onclick = () => { Market.buy(5e4); Market.show(); Market.plot({ anim: false }) }
$('.btn-sell').onclick = () => { Market.sell(5e4); Market.show(); Market.plot({ anim: false }) }
$('.btn-finish').onclick = () => Market.finish()

const tooltip = $('.chart-tooltip')
const chart = $('.chart')
chart.onpointermove = chart.onpointerdown = (e) => {
  if (['chart-circle', 'chart-touch'].some(v => e.target.classList.contains(v))) {
    const { clientX, clientY } = e
    const price = e.target.getAttribute('data-price')
    const operate = e.target.getAttribute('data-operate')
    const rect = chart.getBoundingClientRect()
    Object.assign(tooltip.style, {
      left: `${clientX - rect.left}px`,
      top: `${clientY - rect.top}px`,
      display: 'block',
    })
    tooltip.textContent = [price, operate].join('\n')
  } else {
    tooltip.style.display = 'none'
  }
}
</script>
</body>
